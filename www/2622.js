"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2622],{8088:(C,b,d)=>{d.d(b,{r:()=>f});var s=d(5e3),v=d(1892),c=d(9928);let f=(()=>{class u{constructor(p){this.ui=p,this.imageClass=""}ngOnInit(){}dismiss(){this.ui.dismiss()}affirmative(){this.affirmativeMethod&&(this.affirmativeMethod(),this.dismiss())}}return u.\u0275fac=function(p){return new(p||u)(s.Y36(v.F))},u.\u0275cmp=s.Xpm({type:u,selectors:[["app-little-alert"]],inputs:{image:"image",imageClass:"imageClass",message:"message",imageDivClass:"imageDivClass",affirmativeText:"affirmativeText",negativeText:"negativeText",affirmativeMethod:"affirmativeMethod",negativeMethod:"negativeMethod"},decls:13,vars:6,consts:[[1,"custom-alert"],["alt","",3,"src"],[1,"side-title"],[2,"display","flex","justify-content","center","align-items","center","flex-direction","column","width","90%"],[1,"ion-text-center",2,"font-size","0.9em"],[1,"custom-alert-buttons"],["color","success","fill","outline","size","small","shape","round",3,"click"],["color","success","size","small","shape","round",3,"click"]],template:function(p,h){1&p&&(s.TgZ(0,"ion-content")(1,"div",0)(2,"div"),s._UZ(3,"img",1),s.qZA(),s.TgZ(4,"div",2)(5,"div",3)(6,"p",4),s._uU(7),s.qZA(),s.TgZ(8,"div",5)(9,"ion-button",6),s.NdJ("click",function(){return h.dismiss()}),s._uU(10," Cancelar "),s.qZA(),s.TgZ(11,"ion-button",7),s.NdJ("click",function(){return h.affirmative()}),s._uU(12," Aceptar "),s.qZA()()()()()()),2&p&&(s.xp6(2),s.Tol(h.imageDivClass?h.imageDivClass:"div-image-alert"),s.xp6(1),s.Tol(h.imageClass?h.imageClass:"image-alert"),s.Q6J("src",h.image?h.image:"assets/imgs/campana-de-notificacion.png",s.LSH),s.xp6(4),s.Oqu(h.message?h.message:"El tiempo de espera tiene un costo y el mismo debe ser cancelado"))},dependencies:[c.YG,c.W2]}),u})()},2622:(C,b,d)=>{d.r(b),d.d(b,{PaymentMethodPageModule:()=>z});var s=d(9808),v=d(4182),c=d(9928),f=d(3769),u=d(655),x=d(2340),p=d(9892),h=d(5338),P=d(8088),t=d(5e3),E=d(1892),O=d(7556),Z=d(1335),S=d(7724),I=d(8337),D=d(520);function R(n,g){1&n&&(t.TgZ(0,"label"),t._uU(1,"APLICAR "),t.qZA())}function N(n,g){1&n&&t._UZ(0,"ion-spinner",19)}const G=function(n){return{invalid:n}},U=[{path:"",component:(()=>{class n{constructor(o,e,r,i,a,m,l,q){this.ui=o,this.auth=e,this.router=r,this.request=i,this.iab=a,this.route=m,this.errorS=l,this.http=q,this.loading=!1,this.quotation={},this.address_arr=[{address:"",description:"",latitude:"",longitude:"",hover:!1},{address:"",description:"",latitude:"",longitude:"",hover:!1}],this.az_arr=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],this.total=0,this.error=!1,this.kmadd_base_total=0,this.neighboring=0,this.rate_base=5300,this.kmadd_base=1035,this.neighboring_base=0,this.distance=0,this.duration=0,this.price_per_transport_type={},this.payment_method="efectivo",this.taxes={},this.firstTime=!0,this.couponRedimi=!1}ngOnInit(){localStorage.getItem("quotation")&&(this.quotation=JSON.parse(localStorage.getItem("quotation")),console.log("Quotation",this.quotation))}ionViewDidEnter(){return(0,u.mG)(this,void 0,void 0,function*(){this.couponRedimi=!1,yield p.s.requestPermissions(),this.route.queryParams.subscribe(o=>{this.params=o,console.log("Query params",o)}),Object.keys(this.params).length>0?"APPROVED"==this.params.lapTransactionState&&(this.payment_method="Wompi",this.createOrder()):localStorage.getItem("quotation")&&(this.quotation=JSON.parse(localStorage.getItem("quotation")),console.log("Quotation",this.quotation),this.quotation.couponRedimi&&(this.couponRedimi=this.quotation.couponRedimi))})}selectPaymentMethod(o){this.payment_method=o,"Transferencia bancaria"!=this.payment_method&&this.pay()}logOut(){return(0,u.mG)(this,void 0,void 0,function*(){yield this.ui.presentModal(P.r,{},["modal-xxs","box-shadow-modal"])})}showConfirmDiligence(){return(0,u.mG)(this,void 0,void 0,function*(){const o={image:"assets/imgs/campana.png",imageClass:"image-alert",message:"El tiempo de espera tiene un costo y el mismo debe ser cancelado en efectivo",imageDivClass:"div-image-alert",affirmativeText:"Aceptar",negativeText:"Cancelar",modalWithButtons:!0,affirmativeMethod:()=>{"Wompi"!=this.payment_method?this.createOrder():this.payment()}};yield this.ui.presentModal(P.r,o,["modal-xxxs","box-shadow-modal"])})}view_order(o){return(0,u.mG)(this,void 0,void 0,function*(){(yield this.ui.presentModal(h.G,{order:o},["custom-modal"])).onDidDismiss().then(r=>{})})}createOrder(){return(0,u.mG)(this,void 0,void 0,function*(){const{user:o}=this.auth;console.log("User",o);const e={customer_id:o.id,service_type_id:this.quotation.service_type_id,transport_type_id:this.quotation.transport_type_id,cash_handling:"efectivo"==this.payment_method?1:0,hourly_value:3==this.quotation.service_type_id&&this.quotation.transport_type?this.quotation.transport_type:0,number_hours:this.quotation.number_hour?this.quotation.number_hour:0,driver_count:this.quotation.driver_count?this.quotation.driver_count:0,city_id:this.quotation.city_id,round_trip:this.quotation.round_trip?1:0,distance:this.quotation.distance?this.quotation.distance:0,duration:this.quotation.duration?this.quotation.duration:0,diligence:this.quotation.diligence?1:0,date:this.quotation.date?this.quotation.date:"2020-07-17",range:this.quotation.hour?this.quotation.hour:"09:30PM - 10:00PM",declared_value:this.quotation.cargo_price?this.quotation.cargo_price:0,total:this.quotation.total?this.quotation.total:0,zapp_tool:this.quotation.accessory_id?this.quotation.accessory_id:"",payment_method:this.payment_method,address_arr:3==this.quotation.service_type_id?this.quotation.driver_count_array:this.quotation.address_arr,branch_office_id:4==this.auth.role.id&&this.quotation.branch_office_id?this.quotation.branch_office_id:0};if(3!=e.service_type_id)e.address_arr=e.address_arr.map(i=>({title:"",address:i.address,latitude:i.latitude.toString(),longitude:i.longitude.toString(),description:i.description,contact_name:i.contact_name,contact_phone:i.contact_phone,start_time:"",departure_time:"",total:0,start_time_military_format:"",departure_time_military_format:"",number_of_hours:0}));else{const i=[];for(let a=0;a<e.address_arr.length;a++){const m=e.address_arr[a].driver;for(let l=0;l<e.address_arr[a].address_array.length;l++){const _=e.address_arr[a].address_array[l].start_time_military_format.split(" "),M=_.length>1?_[1]:_[0],y=e.address_arr[a].address_array[l].departure_time_military_format.split(" "),A=y.length>1?y[1]:y[0];i.push({title:m,address:e.address_arr[a].address_array[l].address,latitude:e.address_arr[a].address_array[l].latitude.toString(),longitude:e.address_arr[a].address_array[l].longitude.toString(),description:e.address_arr[a].address_array[l].description,contact_name:e.address_arr[a].address_array[l].contact_name,contact_phone:e.address_arr[a].address_array[l].contact_phone,start_time:e.address_arr[a].address_array[l].start_time,departure_time:e.address_arr[a].address_array[l].departure_time,total:e.address_arr[a].address_array[l].total,start_time_military_format:M,departure_time_military_format:A,number_of_hours:e.address_arr[a].address_array[l].number_of_hours})}}e.address_arr=i}3==e.service_type_id&&(e.range=`${e.address_arr[0].start_time} - ${e.address_arr[e.address_arr.length-1].departure_time}`),1==e.round_trip&&e.address_arr.push(e.address_arr[0]),Object.keys(e).map(i=>{"address_arr"!=i&&(e[i]=e[i].toString())}),console.log(e);const r=yield this.ui.loading("Por favor espere...");this.request.post("order/store_order",e).subscribe(i=>(0,u.mG)(this,void 0,void 0,function*(){(yield r).dismiss(),localStorage.removeItem("quotation"),this.ui.showToast("Orden Creada",()=>(0,u.mG)(this,void 0,void 0,function*(){this.view_order(i.data[0]),yield p.s.schedule({notifications:[{title:"Orden "+i.data[0].id+" Creada",body:"Estamos buscando el mensajero m\xe1s cercano",id:Math.round(100*Math.random()),autoCancel:!0}]})}))}),i=>(0,u.mG)(this,void 0,void 0,function*(){(yield r).dismiss(),console.log("ERror",i),i.error&&i.error.messages?this.ui.showToast(i.error.messages[0]):yield this.ui.presentAlert({mode:"ios",header:"No se ha podido crear la orden",buttons:[{text:"Aceptar",role:"cancel",cssClass:"secondary",handler:a=>{}}]})}))})}pay(){this.quotation.diligence?this.showConfirmDiligence():"Wompi"!=this.payment_method?this.createOrder():this.payment(),console.log("PAy",this.payment_method)}generateGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var e=16*Math.random()|0;return("x"==o?e:3&e|8).toString(16)})}searchTransaction(o,e){return(0,u.mG)(this,void 0,void 0,function*(){const r=yield this.ui.loading("Por favor espere...");localStorage.setItem("isWompiRequest","yes"),this.http.get(`${o}transactions/${e}`).subscribe(i=>(0,u.mG)(this,void 0,void 0,function*(){yield(yield r).dismiss();const m=i.data;localStorage.setItem("transaction",JSON.stringify(m)),"APPROVED"==m.status?this.createOrder():yield this.ui.presentAlert({mode:"ios",header:"Transacci\xf3n no aprobada",message:{PENDING:"La transacci\xf3n se encuentra en estado pendiente",APPROVED:"Aprobada",DECLINED:"La transacci\xf3n ha sido rechazada",ERROR:"Se ha producido un error con la transacci\xf3n",VOIDE:"I don\xb4t know"}[m.status],backdropDismiss:"PENDING"!=m.status,buttons:[{text:"PENDING"==m.status?"Reintentar":"Aceptar",role:"cancel",cssClass:"secondary",handler:l=>{this.searchTransaction(o,e)}}]}),console.log("event url transaction",i)}),i=>(0,u.mG)(this,void 0,void 0,function*(){if(yield r.dismiss(),console.log("event url error",i),401!=i.status&&404!=i.status)if(422!=i.status);else{const a=i.error?i.error.messages.reference[0]:"Error mensage";yield this.ui.presentAlert({mode:"ios",header:"Error",message:a,buttons:[{text:"Aceptar",role:"cancel",cssClass:"secondary",handler:m=>{}}]})}else{const a=404==i.status?"Error no se encontr\xf3 el id":"Error al consultar la transacci\xf3n "+e,m=i.error?i.error.reason:a;yield this.ui.presentAlert({mode:"ios",header:"Error",message:m,buttons:[{text:"Aceptar",role:"cancel",cssClass:"secondary",handler:l=>{}}]})}}))})}payment(){let{publicKey:e,currency:r,postUrl:i,responseUrl:a,urlToFind:m}=x.N.wompiCredentials,_=`\n            <html>\n              <body>\n                <form action="${i}" method="get" id="payu_form">\n                <input name="reference"    type="hidden"  value="${this.generateGuid()}"   >\n                  <input name="public-key"    type="hidden"  value="${e}"   >\n                  <input name="currency"      type="hidden"  value="${r}">\n                  <input type="hidden" name="amount-in-cents" value="${100*this.quotation.total}"/>\n                  <input name="redirect-url"    type="hidden"  value="${a}" >\n                  <button type="submit" value="submit" #submitBtn></button>\n                </form>\n                <script type="text/javascript">document.getElementById("payu_form").submit();<\/script>\n              </body>\n            </html>`;_="data:text/html;base64,"+btoa(_);const M=this.iab.create(_,"_self",{location:"yes",clearcache:"yes",hardwareback:"yes",mediaPlaybackRequiresUserAction:"no",shouldPauseOnSuspend:"no",closebuttoncaption:"Close",disallowoverscroll:"yes",toolbar:"yes",toolbartranslucent:"yes",enableViewportScale:"no",allowInlineMediaPlayback:"no",presentationstyle:"pagesheet",toolbarposition:"bottom",toolbarcolor:"#49158c"});M.on("loadstart").subscribe(T=>(0,u.mG)(this,void 0,void 0,function*(){if(console.log("event url",T.url),T.url.includes(a)){M.close();const y=T.url.replace(a+"?","").split("&").find(A=>A.includes("id=")).replace("id=","");console.log("event url Id",y),this.searchTransaction(m,y)}}))}keyUp(){this.error=!1}applyCoupon(){return(0,u.mG)(this,void 0,void 0,function*(){if(this.coupon){if(this.couponRedimi)return void(yield this.ui.presentAlert({mode:"ios",header:"Ya se ha redimido un cup\xf3n en esta orden",buttons:[{text:"Aceptar",role:"cancel",cssClass:"secondary",handler:e=>{}}]}));const o={customer_id:this.auth.user.id,coupon_code:this.coupon,platform:"mobile"};this.loading=!0,this.error=!1,this.request.post("coupon/redeem_a_coupon",o).subscribe(e=>{this.loading=!1,this.error=!1,this.couponRedimi=!0,console.log("Res",e),this.coupon="";const r=e.data[0];r&&(this.quotation.total=40==r.type_value_id?Number(r.value)<=this.quotation.total?this.quotation.total-Number(r.value):0:this.quotation.total-this.quotation.total*(Number(r.value)/100),this.quotation.couponRedimi=!0,this.quotation.coupon=r,localStorage.setItem("quotation",JSON.stringify(this.quotation)),this.ui.showToast("Se ha redimido tu cup\xf3n exitosamente"))},e=>{this.error=!0,this.loading=!1,console.log("Err",e),this.errorS.response(e,{method:()=>{console.log("Esto es una prueba de error")}})})}else this.error=!0,this.ui.showToast("Debe ingresar un cup\xf3n")})}}return n.\u0275fac=function(o){return new(o||n)(t.Y36(E.F),t.Y36(O.e),t.Y36(f.F0),t.Y36(Z.s),t.Y36(S.i),t.Y36(f.gz),t.Y36(I.Y),t.Y36(D.eN))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-payment-method"]],decls:33,vars:14,consts:[[1,"row","justify-content-center","ion-text-center",2,"margin-top","20%"],[1,"col-md-11","col-lg-10","col-xl-8"],[2,"background","#eeeeee","color","gray","/* padding-right","90px","*/\n    /* padding-left","90px","*/\n    padding","0 16px","border-radius","30px","font-size","1.2em","display","block","width","100%","text-align","inherit","margin","10px auto 0 auto"],[2,"width","80%"],["size","6",2,"height","50px","text-align","right"],[2,"width","100%","height","100%",3,"color","click"],["name","metodo-de-pago"],[2,"font-size","smaller","font-family","'GILROY-EXTRABOLD' !important","text-transform","capitalize"],["size","6",2,"height","50px"],["name","tarjeta-de-debito",2,"font-size","2em"],[2,"width","80%","margin","0 auto 5px auto"],[1,"ion-text-center",2,"margin-top","0"],["lines","none",2,"border","2px solid #49158c","border-radius","20px",3,"ngClass"],["placeholder","Ingresa tu cup\xf3n",3,"ngModel","keyup","ngModelChange"],["mode","ios","slot","end","color","primary",3,"click"],[4,"ngIf"],["style","    height: 20px;\n        ",4,"ngIf"],["mat-line","",2,"text-align","right","background-color","#48158e","color","white","font-size","15px","border-radius","14px","padding","7px","width","80%","margin","auto","font-family","Gilroy-Light"],[2,"float","left","font-size","15px","font-family","Gilroy-Light"],[2,"height","20px"]],template:function(o,e){1&o&&(t.TgZ(0,"ion-content")(1,"div",0)(2,"div",1)(3,"span",2),t._uU(4,"Seleccionar m\xe9todo de pago"),t.qZA()(),t.TgZ(5,"div",3)(6,"ion-grid")(7,"ion-row")(8,"ion-col",4)(9,"ion-button",5),t.NdJ("click",function(){return e.selectPaymentMethod("efectivo")}),t._UZ(10,"ion-icon",6),t.TgZ(11,"ion-label",7),t._uU(12,"Efectivo"),t.qZA()()(),t.TgZ(13,"ion-col",8)(14,"ion-button",5),t.NdJ("click",function(){return e.selectPaymentMethod("Wompi")}),t._UZ(15,"ion-icon",9),t.TgZ(16,"ion-label",7),t._uU(17,"Otros m\xe9todos"),t.qZA()()()()()(),t.TgZ(18,"div",10)(19,"h5",11),t._uU(20,"\xbfTiene un cup\xf3n para redimir?"),t.qZA(),t.TgZ(21,"ion-item",12)(22,"ion-input",13),t.NdJ("keyup",function(){return e.keyUp()})("ngModelChange",function(i){return e.coupon=i}),t.qZA(),t.TgZ(23,"ion-button",14),t.NdJ("click",function(){return e.applyCoupon()}),t.YNc(24,R,2,0,"label",15),t.YNc(25,N,1,0,"ion-spinner",16),t.qZA()()(),t.TgZ(26,"div",17)(27,"span",18)(28,"strong"),t._uU(29,"Total:"),t.qZA()(),t.TgZ(30,"strong"),t._uU(31),t.ALo(32,"currency"),t.qZA()()()()),2&o&&(t.xp6(9),t.Q6J("color","efectivo"==e.payment_method?"primary":"light"),t.xp6(5),t.Q6J("color","efectivo"==e.payment_method?"light":"primary"),t.xp6(7),t.Q6J("ngClass",t.VKq(12,G,e.error)),t.xp6(1),t.Q6J("ngModel",e.coupon),t.xp6(2),t.Q6J("ngIf",!e.loading),t.xp6(1),t.Q6J("ngIf",e.loading),t.xp6(6),t.Oqu(t.gM2(32,7,e.quotation.total,"","symbol","1.0")))},dependencies:[s.mk,s.O5,v.JJ,v.On,c.YG,c.wI,c.W2,c.jY,c.gu,c.pK,c.Ie,c.Q$,c.Nd,c.PQ,c.j9,s.H9]}),n})()}];let J=(()=>{class n{}return n.\u0275fac=function(o){return new(o||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[f.Bz.forChild(U),f.Bz]}),n})(),z=(()=>{class n{}return n.\u0275fac=function(o){return new(o||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[s.ez,v.u5,c.Pc,J]}),n})()}}]);